# 网络概述

对于计算机网络，最重要的思想就是，我们将在Internet或LAN上的两台(或多台)计算机之间交换任意字节的数据。

为了达到此目的，我们需要：

* 甄别源和目标计算机的方案。
* 维护数据完整性的方案。
* 在数十亿的计算机中将数据从一台计算机路由到另一台计算机的方案。

所以，我们需要联合硬件和软件共同协作来到上述目的。让我们从两种最基本的网络交流方式开始旅程。

## 电路交换网络

不必惊慌！目前我们的英特网已经不使用这种网络了（至少就我目前所知的），所以你大可放心，在本章你所读到的知识，你基本都不会再次用上。

对于这种类型的网络，想象一个老派的电话接线员(比如一个人工接线员)。在你还不能直接拨号之前，打一个电话会是这样的:
* 拿起听筒，转动曲柄，产生一个电子信号，在电话线的另一端是在某个地方的电话局，这时他们的电话铃声开始响起。
* 电话那端的接线员听到铃声后会拿起电话，并且和你说，“你好，我是接线员。”
* 这时，你会用你的声音告诉他你想要打的电话号码是什么。
* 接下来，接线员会将跳线插入他们面前的配电盘，在你的电话线路和你想打电话的人的电话线路之间物理地完成电路连接。至此，你的电话就和对方的电话直接联通了。

这种技术的可扩展性很低，假设你必须打长途电话，那就得支付额外的费用，因为在这种情况下，由于线路长度是有限的，所以接线员之前需要互相联系才能完成这种长期距离的电路连接。 

随着时代的发展，人们发现可以用电磁继电器和交换机来取代人工操作员，我们可以通过发送用心编码过的信号来控制这些电路信号。这些信号可以是电脉冲(由旧的旋转拨号电话发送)，也可以是仍然能够被识别的“触摸”音。

不过，我们仍然还有这些问题需要解决:

* 每次通话都需要专用的电路。
* 即使通话者，静静地坐在那里，什么也不说，电话电路仍然会被占用着，其他人完全不能使用。
* 一条线路不能在同时被多人使用。
* 线路数量有物理上限，所能拨出电话数量也是有限的。
  
正因如此，因特网采用了完全不同的尝试。

## 分组报文交换网络

在 _分组交换_ 网络中，欲发送的数据会被分成一个个不同大小的数据包。比如，如果你想发送83,234 字节的数据，那么基本上会分成50或者60个数据包。接下来，在带宽允许的情况下，上述的每个数据包会通过线路单独发送。遐想一下，来自北美各地的计算机的小数据包到达大西洋边缘的路由器，然后通过数千英里长的海底电缆将它们逐个发送到欧洲。一旦数据包到达目标计算机，对端计算机就会从一个个数据包中重建出原始数据。

这个过程很像写一封普通的信件，写完后把它投递在邮局。邮局将这封邮件和一堆其他邮件一起被送到一辆卡车上，但很明显，这车邮件不会和你的被送到同一个最终地址。而邮局会根据合适的物流路线和递送规则将信件投递到最终的目的地。也许你的信和一堆其他的信一起上了飞往国家另一边的飞机，并且当飞机到达时，这些信件可能会分开，一些向北，一些向南。很明显，邮局不可能仅仅一整架飞机去运送一封邮件。而这里的邮件就很像网络中的数据包，他们被从一个地方转发到另一个地方。

与此类似，互联网上的数据包也是从一台计算机转发到另一台计算机，这之间的线路被计算机们共享，直到它们最终到达它们要去的地方。这些设计为计算机网络带来了一些巨大的好处:

* 在每一对通信计算机之间不需要都有一对一的专用电路(而且在当今的计算机规模中，这已经是物理上不可能的事情了)。
* 多台计算机都可以使用同一条线路在“同一”时间发送数据。(这些数据包实际上是一次发送一个，但它们是交错的，所以看起来是同时发送的。)
* 物理电线可以被充分利用，如果有计算机想要使用，线路上就不会有死寂。在一条线路上，一台计算机的沉默就是另一台计算机传输信息的机会。

## 客户端/服务器架构

对于这个概念，你一定从使用网站中了解过，通常人们会说网站服务器。

_服务_ 是指一种程序，这种程序 _监听_ 可能会接入的连接，_接受_ 它们发来的请求，并且回复一些消息，这个接收回复消息的程序就叫做 _客户端_。当然，取决于服务器的业务逻辑，服务器和客户端之间的实际的交互细节比上述的要复杂得多。

本质上，客户端和服务器都是一种网络程序，它们之间的最大区别是，服务器程序是被动等待客户端主动调用来连接的程序。通常，一个服务器可以被很多客户端同时连接。一个服务器集群中可能存在许多服务器，以服务许多、许多、许多客户端。你可以想象有多少客户端连接着谷歌的服务器。 

## 操作系统，计算机网络与套接字

最本质的网络是一种计算机硬件系统，而通过操作系可以控制对硬件的访问。因此，如果你想编写使用网络的软件，必须借助操作系统的帮助。

一直以来，这个操作都是通过在Unix上首创的一个叫做 _套接字_ 的API来实现的。Unix套接字API是一个通用的概念，在它繁多的功能中，其中之一就是可以为用户提供在Internet中读写数据的方法。随着时间的发展，在其它的语言和操作系统中也添加了类似的网络通信功能的API，并且赋予了它们不同的名字。但是作为对于初创者的致敬，即使和原创已经不尽相同，但是这其中大部分API还是使用”套接字“这个名字。

如果你想体验最原始纯正的套接字API，你可以使用Unix里面的C语言的socket API。

## 协议

你知道客户端和服务器之间具体的对话内容是什么样的么？它详细规定了什么字节何时从谁发送到谁。用户不能将过时的数据发送到网站服务器——这种情况下，服务器用一种确定的方法丢弃旧数据。就像你不能写一封信，然后把它用铝箔纸包起来，并且不写地址，但是你还指望邮局把它送到你的收件人那里。这肯定做不到，因为这违反了邮局的 _规定_。

在生活中，信息发送方和信息接收方必须使用相同的协议才能进行正确的通信。比如：
> “感谢您致电披萨餐厅。我能帮你吗?”
> 
> “我想要一个加薯条的披萨”
> 
> 打电话定披萨的人违反了披萨店的订餐协议。

在计算机网络中，有许许多多的协议，在本文后续中，我们会详细介绍其中的一部分。这些协议都是为了解决用户不同的问题。如果你想要在你自己编写的定制程序间传输数据，你也需要定义你自己的通信协议。

这里有一些你可能听过的协议名称：

* TCP - 用来可靠的传输数据。
* UDP - 用来快速的传输数据，但是不保证可靠性。
* IP  - 用来规定如何在网络的计算机之间路由数据包。
* HTTP - 用来访问网站或者接受其他网页请求。
* Ethernet - 用来定义如何在LAN链路上传输数据。
  
下面我们还会看到，这些协议都工作在计算机网络软件的不同层级中。

## 网络层次和抽象

下面简要介绍一下数据在网络上传输时会发生什么，在接下来的内容中会围绕着这个点更详细的阐述。 

1. 如果一个用户的程序说：“我想个给那边的网站服务器发送'GET / HTTP/1.1'“（在网络中，服务器是以 _IP地址_ + _端口_ 来标示的）。 
2. 操作系统收到用户程序发送出来的数据并且将它们放在一个 _消息头_中（简单的说，就是会在用户数据之前添加一些额外数据）并且提供一些错误检测（还可能有排序）的信息。通信协议会具体定义消息头的结构，比如，TCP或者UDP。 
3. 操作系统会接受上一步的所有内容，并且再次把这个整体放入一个带有路由新的的消息头中。IP协议定义了如何构造这一步的数据头。
4. 接下来，操作系统将上一步所有数据交给网络接口（一般称之为 _网卡_, 计算机中负责网络的硬件设备）。
5. 同样，网卡会把上一步产生的整个数据包放到另一个消息头中，一些协议比如Ethernet协议定义了这一层消息头格式，使得数据可以在LAN上被发送。
6. 最后，网卡会将上述完整而又多重封装的数据发送出去，既可以是通过线路，也可以是通过空气（在WiFi的帮助下）。

当接收计算机收到上述数据包时，会进行相反的过程。它的网卡剥离Ethernet消息头，这样IP信息就会暴露给操作系统，操作系统确保IP地址是正确的，找出哪个程序在该端口上侦听，并将完全解析的数据发送给正确的程序。

完成封装这所有这些不同层次的行为称为 _协议栈_ (这里“栈”一词与数据结构中的“堆栈”里的“栈”意思完全不同。)。

在这个过程中，由于不同层次负责完全不同的工作，所以使得整个过程都运作的很好。举个例子，一层负责数据完整性，一层负责将数据包在网络中进行路由，一层负责数据本身能在两个应用程序中被传输。每一层并不关心在它之下的层级对于数据正在做些什么。

最后，有一个很重要的概念：当然使用WiFi发送数据时，WiFi的硬件并不关心发送的数据是什么，它是因特网数据与否，数据完整性如何保证（或者不用不用保证）。WiFi只关心将一大块数据通过空气传给另外一个计算机。当数据到达另一方计算机，该计算机会剥离Ethernet相关的信息从而可以更加深入的查看数据包，再决定如何进行下一步处理。

由于这种设计中，上一层并不用关心什么数据被封装在了下一层，所以你可以将下面层次中用到的协议随意改变并且保持这一层仍然有效运作。所以当你在协议最高层编写程序时（这也是程序员经常做的），你根本不用关心下面的层级中发生了什么。通常，他们都是其它人需要解决的问题。

举一个具体的例子，你可以通过HTTP/TCP/IP/Ethernet访问到一个网页，或是通过TFTP/UDP/IP/Ethernet将文件传送给另外一个计算机。在这个过程中都有IP和Ethernet协议，因为他们并不关心他们上层的数据是怎么被发送的。

在上面的叙述中，我们省去了很多细节，不过在宏观上，整个过程和上面描述的是一致的。 

## 有线和无线

当我们谈论局域网时，网络编程在这两种情况下：

* 局域网中的计算机通过有线的Ethernet网线连接[1]。
* 局域网中的计算机通过同一WiFi接入点连接。
  
它们在底层都是用Ethernet协议进行的通信。所以，当我们说计算机位于同一局域网，意思是它们要么通过网线连接在一起或者连接的同一个WiFi接入点。

[1] “以太网电缆”这个说法其实有点不准确，因为这里一般指的是电线本身，而以太网是一种协议，它有效地定义了通过这些电缆的电流模式。但这里我想表述的意思是“通常与以太网一起使用的电缆”。

## 思考题

* 因特网用的是哪种交换网络？ 
  
* 客户端程序和服务器程序的关系是什么？
  
* 在编写的网络程序中，操作系统发挥了一个什么角色？
   
* 协议是什么意思？
 
* 协议栈和网络封装的意义是什么？
  
* 无线网络和有线网络的关键区别是什么？

