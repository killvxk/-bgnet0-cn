# Sockets（套接字）API

在Unix中，套接字API进程提供了一种通用的相互通信的方式。它支持很多种通信方式，其中一种是通过因特网进行通信。而这正是我们现在感兴趣的一个知识点。

在C语言和Unix中，套接字API是用户态库调用和系统调用(直接调用操作系统的函数)的混合体。 在Python中，至少在类Unix系统中，套接字API库是调用的是C语言的套接字API。在其它语言中，它调用的是操作系统暴露给它的网络通信接口。 

接下来，我们将动手写一些可以通过Internet通信的程序！ 

## 客户端连接过程

在使用套接字的过程中，让用户最疑惑不解的部分是当连接到另外一台电脑前，需要进行好几步才能完成连接。而这整个过程并不是显而易见的。

这个主要的过程是: 

1. **向操作系统申请一个套接字**。在C语言中，套接字是一个用来记录网络连接的文件描述符（一个整数）。在Python中，将会用一个对象来表示一个套接字。在不同的语言中，可能会由不用的概念来表示套接字。但这里最重要的是，程序端需要有一个标示物来指向接下来的数据传输。请注意，这个步骤完成时，并没有连接到一个具体的东西。

2. **通过查询DNS** 将一个人类可读的字符串（比如`example.com`）转化为一个IP地址（比如 198.51.100.12）。DNS是一个分布式的数据库，用户可以通过对它进行查询来得到一个IP地址。我们需要知道IP地址，这样我们才能知道该链接到哪个机器。
   - Python提示: 当你在Python中使用机器名调用`socket.connect()`，这个函数会自动调用`socket.getaddrinfo()`做一次DNS查询。
   - C语言提示: 在C语言中，可以使用`getaddrinfo()` 进行DNS查询。

3. **连接套接字** 到对应的IP的地址和一个指定的端口。 一个端口就好比是一扇你可以通过的门，它们用序号0到65535表示。比如，一个熟知的端口号是80，这是互联网上使用HTTP协议（未加密）进行通信的端口。在远端，必须要有一个正在监听的端口，不然连接将会失败。

4. **发送和接收数据**。这是我们期待已久的部分，计算机网络中，数据就是一串字节。 

5. 关闭连接。当数据传输完毕，链接到远端的套接字会被关闭因为我们已经没有什么可以传输了。远端亦可按照自己的意愿关闭套接字。

## 服务器端监听过程

编写服务器端程序有些许不同。

1. **向操作系统申请一个套接字**。这点和客户端无异。
   
2. **将套接字绑定到一个端口**。在服务端，你需要暴露出一个其它服务器可以连接上的端口，比如，“我要在80端口上开始监听啦！”
   注意:非根账号或者管理员身份运行的程序是不能绑定到1024以下的端口的，这些端口是计算机的保留端口。应该给服务程序选择一个大的、不知名的端口号，比如1.5万到3万之间的端口号。如果程序尝试绑定到一个服务器正在使用的端口，那么将会得到“地址已在使用”错误。
   计算机之间的端口号是独立的，不同的计算机之间使用一样端口号是没有问题的，但是同一台计算机的上的两个程序是不能使用同一个端口号的。
   有趣的事实：客户端程序在通信时也是会绑定到一个端口上的，如果你没有显示的制定它们，它们会自动绑定到一个没有被使用过的端口上——通常这正是我们想要的。

3. **监听将要到来的连接**。程序需要让操作系统知道什么时候在我们选定的端口上会有要到来的连接。

4. **接受到来的连接**。如果没有任何连接，服务器会阻塞（表现为sleep）等待新的连接。当新的连接到来时，它会被唤醒。当连接被接受时，会返回一个新的套接字，在第一步里面负责监听的套接字会依然保持监听状态，操作系统会为每一个连接都特意的创造一个新的套接字。正因为这样，服务器才能同时处理很多连接。有时，服务器会创建一个新的线程或者进程去处理每一个连接上来的客户端，不过并没有规则说服务器端一定要这样做。

5. **发送和接收数据**。通常情况下，服务器会从客户端接收请求，然后服务器会发回对该请求的响应。

6.  **继续监听和接受新的连接**。服务器一般都是永不推出的进程并且在其生命周期内尽可能的处理更多的请求。

## 思考题

* `bind()`函数在服务器端扮演的角色是什么？ 

* 客户端程序调用 `bind()`函数会发生什么？（可能需要在因特网上搜索下这个问题的答案） 

* 思考一下为什么 `accept()` 返回一个新的套接字，而不是仅仅重用`listen()`返回的套接字。 

* 如果服务器在一次`accept()`之后没有继续循环等待新的连接会怎么样？这时如果有个新的连接会发生什么？ 

* 如果一个计算机通过端口号3490使用TCP协议，其它计算机可以使用同一端口号么？ 

* 思考一下为什么存在端口号这个概念，它能提供IP地址所不能提供的哪些功能？ 

## 资源

* [Python 套接字文档](https://docs.python.org/3/library/socket.html)
* [flbg[_Beej's Guide to Network Programming_|bgnet]]--可选，C语言版
